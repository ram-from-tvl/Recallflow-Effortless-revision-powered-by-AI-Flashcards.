{% extends "base.html" %}

{% block title %}{{ flashcard_set.topic }} - Flashcards{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Header -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1 class="h3 mb-1">{{ flashcard_set.topic }}</h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-cards-blank me-2"></i>{{ flashcard_set.card_count }} cards
                    {% if flashcard_set.created_at %}
                        <span class="ms-3">
                            <i class="fas fa-calendar me-2"></i>{{ flashcard_set.created_at.strftime('%B %d, %Y') }}
                        </span>
                    {% endif %}
                </p>
            </div>
            <div>
                <a href="{{ url_for('all_flashcards') }}" class="btn btn-outline-secondary me-2">
                    <i class="fas fa-arrow-left me-2"></i>Back to All Sets
                </a>
                <form method="POST" action="{{ url_for('delete_flashcard_set', set_id=flashcard_set.id) }}" class="d-inline" 
                      onsubmit="return confirm('Are you sure you want to delete this flashcard set?')">
                    <button type="submit" class="btn btn-outline-danger">
                        <i class="fas fa-trash me-2"></i>Delete
                    </button>
                </form>
            </div>
        </div>

        <!-- Study Mode Controls -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h5 class="mb-2">Study Mode</h5>
                        <p class="text-muted mb-0">Click cards to flip and test your knowledge</p>
                    </div>
                    <div class="col-md-6 text-md-end">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" id="showAllBtn">
                                <i class="fas fa-eye me-2"></i>Show All Answers
                            </button>
                            <button type="button" class="btn btn-outline-secondary" id="hideAllBtn">
                                <i class="fas fa-eye-slash me-2"></i>Hide All Answers
                            </button>
                            <button type="button" class="btn btn-outline-info" id="shuffleBtn">
                                <i class="fas fa-random me-2"></i>Shuffle
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="mb-4">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="text-muted">Study Progress</span>
                <span class="text-muted" id="progressText">0 / {{ flashcard_set.card_count }} cards studied</span>
            </div>
            <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: 0%" id="progressBar"></div>
            </div>
        </div>

        <!-- Flashcards -->
        <div id="flashcardsContainer">
            {% for card in flashcard_set.flashcards %}
                <div class="card flashcard mb-3" data-card-id="{{ loop.index0 }}">
                    <div class="card-body">
                        <div class="flashcard-inner">
                            <!-- Question Side -->
                            <div class="flashcard-front">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <span class="badge bg-primary">Question {{ loop.index }}</span>
                                    <span class="text-muted small">Click to reveal answer</span>
                                </div>
                                <h5 class="card-title">{{ card.question }}</h5>
                                <div class="text-center mt-4">
                                    <button class="btn btn-outline-primary flip-btn">
                                        <i class="fas fa-redo me-2"></i>Show Answer
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Answer Side -->
                            <div class="flashcard-back" style="display: none;">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <span class="badge bg-success">Answer {{ loop.index }}</span>
                                    <span class="text-muted small">Click to show question</span>
                                </div>
                                <h6 class="card-subtitle mb-3 text-muted">{{ card.question }}</h6>
                                <p class="card-text">{{ card.answer }}</p>
                                <div class="text-center mt-4">
                                    <button class="btn btn-outline-secondary flip-btn me-2">
                                        <i class="fas fa-undo me-2"></i>Show Question
                                    </button>
                                    <button class="btn btn-success mark-studied-btn">
                                        <i class="fas fa-check me-2"></i>Mark as Studied
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Study Summary -->
        <div class="card bg-light mt-4">
            <div class="card-body text-center">
                <h5>Study Complete!</h5>
                <p class="text-muted mb-3">Great job studying {{ flashcard_set.topic }}!</p>
                <div class="d-flex justify-content-center gap-3">
                    <a href="{{ url_for('create_flashcards') }}" class="btn btn-primary">
                        <i class="fas fa-plus me-2"></i>Create More Flashcards
                    </a>
                    <a href="{{ url_for('all_flashcards') }}" class="btn btn-outline-primary">
                        <i class="fas fa-layer-group me-2"></i>View All Sets
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let studiedCards = new Set();
const totalCards = {{ flashcard_set.card_count }};

// Flip card functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.flip-btn') || e.target.closest('.flashcard-inner')) {
        const card = e.target.closest('.flashcard');
        const front = card.querySelector('.flashcard-front');
        const back = card.querySelector('.flashcard-back');
        
        if (front.style.display !== 'none') {
            // Show answer
            front.style.display = 'none';
            back.style.display = 'block';
        } else {
            // Show question
            front.style.display = 'block';
            back.style.display = 'none';
        }
    }
});

// Mark as studied functionality
document.addEventListener('click', function(e) {
    if (e.target.closest('.mark-studied-btn')) {
        const card = e.target.closest('.flashcard');
        const cardId = card.getAttribute('data-card-id');
        
        studiedCards.add(cardId);
        card.classList.add('studied');
        
        updateProgress();
    }
});

// Control buttons
document.getElementById('showAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.flashcard').forEach(card => {
        const front = card.querySelector('.flashcard-front');
        const back = card.querySelector('.flashcard-back');
        front.style.display = 'none';
        back.style.display = 'block';
    });
});

document.getElementById('hideAllBtn').addEventListener('click', function() {
    document.querySelectorAll('.flashcard').forEach(card => {
        const front = card.querySelector('.flashcard-front');
        const back = card.querySelector('.flashcard-back');
        front.style.display = 'block';
        back.style.display = 'none';
    });
});

document.getElementById('shuffleBtn').addEventListener('click', function() {
    const container = document.getElementById('flashcardsContainer');
    const cards = Array.from(container.children);
    
    // Shuffle array
    for (let i = cards.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [cards[i], cards[j]] = [cards[j], cards[i]];
    }
    
    // Re-append in new order
    cards.forEach(card => container.appendChild(card));
});

function updateProgress() {
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const percentage = (studiedCards.size / totalCards) * 100;
    
    progressBar.style.width = percentage + '%';
    progressText.textContent = `${studiedCards.size} / ${totalCards} cards studied`;
    
    if (studiedCards.size === totalCards) {
        progressBar.classList.add('bg-success');
        // Could show completion modal or animation here
    }
}

// Keyboard navigation
document.addEventListener('keydown', function(e) {
    if (e.code === 'Space') {
        e.preventDefault();
        // Flip the first visible card
        const visibleCard = document.querySelector('.flashcard:not(.studied)');
        if (visibleCard) {
            const flipBtn = visibleCard.querySelector('.flip-btn');
            if (flipBtn) flipBtn.click();
        }
    }
});

// Add CSS for studied cards
const style = document.createElement('style');
style.textContent = `
    .flashcard.studied {
        opacity: 0.7;
        border-left: 4px solid #28a745;
    }
    
    .flashcard {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .flashcard:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .flashcard-inner {
        min-height: 200px;
    }
`;
document.head.appendChild(style);
</script>
{% endblock %}
